# Session 51: Homelab Deduplication & Photo Organization Setup

**Date:** 28 Dec 2025  
**Status:** ✅ Script running on homelab (Phase 1+2 in progress)

## Summary

Established a comprehensive deduplication analysis system for the homelab's 918backup2512 folder (3.6TB, 82,163 files). Created infrastructure and scripts to:
1. Identify all duplicate files
2. Find phone photo folders (for moving to immich)
3. Find screenshot files (for consolidation)

## Accomplishments

### 1. ✅ Created Claude Outpost on Homelab
- **Location:** `/home/ugreen-homelab-ssh/claude-outpost/`
- **Structure:** Well-organized folder hierarchy with:
  - `scripts/deduplication/` - Dedup scripts
  - `data/deduplication/` - Analysis results
  - `logs/deduplication/` - Execution logs
  - `docs/` - Documentation
  - Complete README.md with usage instructions

### 2. ✅ Designed Three-Phase Approach
- **Phase 1+2 (Combined):** Full hash scan + duplicate/phone/screenshot detection
- **Phase 3:** User reviews reports and makes decisions
- **Phase 4:** Execute deduplication, moves, and cleanup (next session)

### 3. ✅ Created Scripts
- **20251228-phase1-2-full-scan-and-analyze.sh** (Main script)
  - Scans all 82,163 files
  - Generates MD5 hashes with metadata
  - Analyzes hashes for duplicates
  - Identifies phone photo folders (telefon, iPhone, samsung, etc.)
  - Identifies screenshot files
  - Generates 3 detailed reports

- **20251228-phase4-dedup-execute.sh** (Execution script - Phase 4)
  - Dry-run mode for preview
  - Safe deletion with newest file preservation
  - Logging for recovery

### 4. ✅ Fixed Critical Issues
- **Issue 1:** Permission denied on scripts
  - Fixed by changing owner to ugreen-homelab-ssh
  - Set correct permissions (755)

- **Issue 2:** Bash script bug in first version
  - Problem: Pipe to while loop with output redirect caused exit
  - Solution: Simplified to direct output redirection

- **Issue 3:** User authentication
  - Set password for ugreen-homelab-ssh user
  - Enabled local su access

## Current Status

**Script Status:** ✅ RUNNING
- Start time: 07:46:23 CET
- Total files: 82,163
- Estimated completion: 2-5 hours
- Status: Processing hash generation

**Expected Output (3 Reports):**
1. `duplicates-report.txt` - All duplicate file groups
2. `phone-folders-list.txt` - Phone photo folders for review
3. `screenshots-list.txt` - Screenshot files

**Location:** `/home/ugreen-homelab-ssh/claude-outpost/data/deduplication/`

## Next Steps (Session 52+)

1. **Check script completion** (when it finishes in 2-5 hours)
2. **Review three reports** generated by Phase 1+2
3. **Make decisions:**
   - Which duplicates to delete
   - Which phone folders to move to immich
   - Where to consolidate screenshots
4. **Run Phase 4 script** with deduplication execution

## Technical Details

### Detection Patterns Used
**Phone Folders:**
- Keywords: telefon, telefonu, iPhone, samsung, xiaomi, huawei, motorola, oneplus, oppo, nokia
- Directories: DCIM, Camera, Photos, Pictures, Gallery

**Screenshots:**
- Filename patterns: "screenshot", "screen shot" (case-insensitive)
- Also detects: "Снимок" (Cyrillic for screenshot)

### Expected Space Savings
- **Conservative:** 34-54GB (obvious duplicates removed)
- **Aggressive:** Up to 220GB (if folder 09-20221217 is master backup)

## Infrastructure Created

### Outpost Structure
```
/home/ugreen-homelab-ssh/claude-outpost/
├── scripts/deduplication/
│   ├── 20251228-phase1-2-full-scan-and-analyze.sh
│   └── 20251228-phase4-dedup-execute.sh
├── data/deduplication/
│   └── [results will appear here]
├── logs/deduplication/
│   └── [execution logs]
└── README.md (with complete usage instructions)
```

### Maintenance Scripts Created
- `cleanup-old-logs.sh` - Archive logs >30 days (weekly)
- `cleanup-old-data.sh` - Remove temp files >30 days (monthly)

## Lessons Learned

1. **Bash subshell issues:** Complex pipe/redirect logic in bash can cause silent failures
   - Solution: Keep scripts simple and direct

2. **Permission management:** Always verify ownership and permissions for multi-user access
   - Solution: Set 755 on shared scripts

3. **Script debugging:** Use `bash -x` for detailed execution trace
   - Helped identify the subshell issue

## Commands Reference

**Run the script:**
```bash
ssh ugreen-homelab-ssh@192.168.40.40 'bash /home/ugreen-homelab-ssh/claude-outpost/scripts/deduplication/20251228-phase1-2-full-scan-and-analyze.sh'
```

**Check progress:**
```bash
ssh ugreen-homelab-ssh@192.168.40.40 'tail -20 /home/ugreen-homelab-ssh/claude-outpost/logs/deduplication/*phase1*.log'
```

**View reports when done:**
```bash
ssh ugreen-homelab-ssh@192.168.40.40 'ls -lh /home/ugreen-homelab-ssh/claude-outpost/data/deduplication/*report*'
```

## Resources
- Plan: `/home/sleszugreen/.claude/plans/sparkling-inventing-knuth.md`
- Homelab Outpost: `/home/ugreen-homelab-ssh/claude-outpost/`
- Documentation Hub: Outpost README.md

---

**Session Duration:** ~1 hour (planning + setup + script creation)  
**Session Completed:** Yes, awaiting script execution results
**Ready for Next Session:** Yes
